# 🛡️ FoodLens 대시보드 안정성 개선 리포트

## 개요 (Executive Summary)

본 리포트는 `app/(tabs)/index.tsx` (홈 대시보드) 화면에서 발생할 수 있는 주요 에러 케이스와 그에 대한 **실무 개발자 관점**의 대응 방안을 제안합니다. 특히 사용자 경험에 치명적인 권한 문제와 데이터 무결성 문제를 중점적으로 다루며, 앱의 흐름을 끊지 않는 방어적 프로그래밍 구현을 목표로 합니다.

---

## 1. 권한 핸들링 (카메라, 갤러리 및 위치) [완료 ✅]

**문제점:** 사용자가 필수 권한(카메라, 사진 라이브러리) 또는 선택 권한(위치)을 거부했을 때, 기능 실행 시 앱이 멈추거나 크래시 발생.
**제안된 해결책:**

- **통합 권한 가드(Guard) 패턴:** `usePermissionGuard(type)` 커스텀 훅을 만들어 각 권한(카메라/갤러리/위치) 상태를 일관되게 관리합니다.
- **권한별 세분화 전략:**
  - **카메라/갤러리 (필수):** `launchCameraAsync` 호출 전 권한 확인. `denied` 상태라면 "분석을 위해 카메라 접근 권한이 필요합니다"라는 알림과 함께 `Linking.openSettings()`로 설정창 이동을 유도합니다.
  - **위치 정보 (선택):** 갤러리/카메라 사용 시 EXIF 태그 읽기를 시도하되, 위치 권한이 없으면 **조용히 실패(Silent Fail)**하고 기본값(위치 정보 없음)으로 진행합니다. 절대 위치 권한 없다고 핵심 기능(분석)을 막아서는 안 됩니다.
  - **권한 요청 시점 최적화:** 앱 시작 시 한꺼번에 요청하지 않고, 실제로 '카메라 버튼'을 눌렀을 때 요청하여 거부감을 줄입니다.

## 2. 네트워크 연결성 [완료 ✅]

**문제점:** 오프라인 환경에서 대시보드 진입 시 무한 로딩되거나 API 에러 발생.
**제안된 해결책:**

- **오프라인 모드 지원:** `@react-native-community/netinfo`를 도입합니다.
  - 오프라인 감지 시 로컬 스토리지(`MMKV` 등)에 캐시된 이전 분석 기록을 우선 보여줍니다.
  - 상단에 "오프라인 모드: 일부 기능이 제한됩니다"라는 비침해적(Non-intrusive) 배너를 표시합니다.
- **지수 백오프(Exponential Backoff) 재시도:** API 호출 실패 시, 1초, 2초, 4초 간격으로 최대 3회 자동 재시도하는 로직을 서비스 계층에 구현합니다.

## 3. 서버 설정 및 유효성 검사

**문제점:** 사용자가 잘못된 서버 URL(예: `http://` 누락)을 입력하여 통신 불가.
**제안된 해결책:**

- **입력값 검증 (Zod):** 저장 전 URL 형식을 `z.string().url()`로 엄격하게 검증합니다.
- **연결 테스트 (Ping):** 설정 모달에 `Test Connection` 버튼을 추가합니다. 해당 URL의 `/health` 엔드포인트로 가벼운 요청을 보내 200 OK 응답을 받을 때만 "저장" 버튼이 활성화되도록 합니다.

## 4. 프로필 데이터 무결성 [완료 ✅]

**문제점:** 사용자 프로필 데이터가 `null`이거나 구조가 깨져 렌더링 중 크래시 발생.
**제안된 해결책:**

- **기본 객체(Default Object) 패턴:** API 응답이 `null`일 경우 `const user = fetchedData || DEFAULT_USER_PROFILE;`과 같이 안전한 기본값을 할당합니다.
- **경계 검증:** API 응답 시점에 데이터 구조를 검증하고, 필수 필드가 누락된 경우 에러 로그를 남기고 빈 데이터로 처리하여 UI 렌더링을 보장합니다.

## 5. 로컬 스토리지 신뢰성 [완료 ✅]

**문제점:** `AsyncStorage` 데이터(JSON) 손상으로 인한 파싱 에러 및 앱 실행 불가.
**제안된 해결책:**

- **Safe Parsing 유틸리티:** `JSON.parse`를 `try-catch`로 감싸는 래퍼 함수를 사용합니다. 파싱 실패 시 해당 키 데이터를 초기화하여 앱을 스스로 복구(Self-healing)하게 만듭니다.
- **고성능 스토리지 도입:** 데이터 안정성과 속도를 위해 동기식 스토리지인 `react-native-mmkv`로 마이그레이션을 권장합니다.

## 6. 이미지 및 파일 무결성 [완료 ✅]

**문제점:** 원본 사진이 폰에서 삭제되어 리스트에 엑스박스(이미지 깨짐)가 뜸.
**제안된 해결책:**

- **파일 존재 체크:** 렌더링 전 `FileSystem.getInfoAsync`로 이미지 경로 유효성을 확인하고, 없는 경우 리스트에서 자동 제외하거나 안내 문구를 표시합니다.
- **SecureImage 컴포넌트:** 이미지 로드 에러(`onError`) 발생 시 자동으로 "이미지를 찾을 수 없음"을 나타내는 플레이스홀더 아이콘으로 교체하는 컴포넌트를 사용합니다.

## 7. 낙관적 UI (Optimistic UI) 롤백 [완료 ✅]

**문제점:** 삭제 동작이 서버에서 실패했으나 앱에서는 삭제된 것처럼 보임 (데이터 불일치).
**제안된 해결책:**

- **롤백 메커니즘:**
  1.  삭제 전 현재 상태 백업 (`previousData`).
  2.  UI에서 선반영(삭제).
  3.  서버 요청 실패 시 `setList(previousData)`로 즉시 원복하고 에러 토스트를 띄웁니다.
  - 안정적인 상태 관리를 위해 `React Query (TanStack Query)` 도입을 적극 추천합니다.

## 8. EXIF 데이터 처리 (GPS) [완료 ✅]

**문제점:** 사진에 위치 정보가 없거나 포맷이 다를 때 접근하면 에러 발생.
**제안된 해결책:**

- **방어적 코딩:** `asset.exif` 존재 여부를 항상 체크합니다. (`asset.exif?.GPSLatitude`)
- **값 검증:** 가져온 위도/경도 값이 유효 범위(-90 ~ 90)인지 확인 후 사용하며, 유효하지 않은 경우 `null`을 전달하여 지도에서 에러 없이 "위치 정보 없음"으로 처리되도록 합니다.

## 9. UI 상태 충돌 방지 [완료 ✅]

**문제점:** 두 개의 모달이 동시에 뜨거나 네비게이션 동작이 꼬임.
**제안된 해결책:**

- **단일 상태 관리:** `activeModal`이라는 하나의 상태 변수(`ENUM`)로 관리하여 물리적으로 동시 실행을 차단합니다.
- **인터랙션 대기:** 화면 전환 애니메이션이나 모달 닫힘 동작이 완료된 후(`InteractionManager.runAfterInteractions`) 무거운 데이터 로딩을 시작하여 버벅임을 방지합니다.

## 10. 전역 에러 경계 (Global Error Boundary) [완료 ✅]

**문제점:** 특정 컴포넌트 에러로 앱 전체가 종료(White Screen)됨.
**제안된 해결책:**

- **ErrorBoundary 적용:** 앱 최상위 또는 주요 기능 단위(리스트, 상세화면)에 `ErrorBoundary`를 감싸서, 에러 발생 시 "일시적인 오류입니다. 다시 시도해주세요"라는 Fallback UI를 보여주고 앱 전체 종료를 막습니다.

---

### 💡 우선순위 제안

1.  **High (필수):** 권한 핸들링(위치 포함) & 네트워크 재시도 전략
2.  **Medium (권장):** 낙관적 UI 롤백 & 데이터 기본값 처리
3.  **Low (개선):** 전역 에러 경계 & 모달 상태 통합
